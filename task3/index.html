<html>
	<head>
		<title>Task 3</title>
		<style type="text/css">
		body { 
			text-align: center; }
		#game { 
			background-color: #222; 
			margin-top: 30px; }
		</style>
		<script type="text/javascript" src="jquery.min.js"></script>
		<script type="text/javascript">
		$(function() {

			var canvas = $('#game')[0]
			  , ctx = canvas.getContext('2d')
			  , g_width = ctx.canvas.width
			  , g_height = ctx.canvas.height;

			var GRID_ROWS = 24
			  , GRID_COLUMNS = 16
			  , S_ON = 1
			  , S_OFF = 0;

			var shapes = []
			  , currentShape = null
			  , ticker = null
			  , score = 0;

			// bind left and right keys
			$('body').bind('keyup', function(e) {
				var key = e.keyCode;
				if (key === 37) { // left
					currentShape.moveLeft();
				} else if (key === 39) { // right
					currentShape.moveRight();
				} else if (key === 38) { // up
					currentShape.rotateLeft();
				} else if (key === 40) { // down
					currentShape.rotateRight();
				}
			});

			function Block(i, j) {
			    this.i = i;
			    this.j = j;
			    this.w = 25;
			    this.h = 25;
			    this.x = this.w * this.j;
			    this.y = this.w * this.i;
			    this.s = S_OFF;
			}

			Block.prototype.update = function () {
			}

			Block.prototype.draw = function () {
			    switch(this.s) {
			        case S_ON:
			            ctx.fillStyle = '#ff0000';
			            ctx.fillRect(this.x, this.y, this.w, this.h);
			            break;
			        case S_OFF:
			            break;
			    }
			}

			function getBelow(b) {
			    if (b.i + 1 >= GRID_ROWS) {
			        return null;
			    }
			    return map[b.i+1][b.j];
			}

			function getLeft(b) {
				if (b.j - 1 < 0) {
					return null;
				}
				return map[b.i][b.j-1];
			}

			function getRight(b) {
				if (b.j + 1 >= GRID_COLUMNS) {
					return null;
				}
				return map[b.i][b.j+1];
			}

			function switchBlock(b1, b2) {
				b1.s = S_OFF;
				b2.s = S_ON;
				return b2;
			}

			function S1(b1, b2) {
				this.b1 = b1;
				this.b2 = b2;
			 	this.b1.s = S_ON;
			 	this.b2.s = S_ON;
			 	this.s = S_ON;
			}

			S1.prototype.moveLeft = function () {
				var l1 = getLeft(this.b1);
				var l2 = getLeft(this.b2);

				this.s = S_OFF;

				if (l1 == null || l2 == null) {
					return;
				}

				if (l2 != this.b1) {
					if (l1.s == S_ON || l2.s == S_ON) return;
				} else {
					if (l1.s == S_ON) return;
				}

				this.b1 = switchBlock(this.b1, l1);
				this.b2 = switchBlock(this.b2, l2);

				this.s = S_ON;

			}

			S1.prototype.moveRight = function () {
				var r1 = getRight(this.b1);
				var r2 = getRight(this.b2);

				this.s = S_OFF;

				if (r1 == null || r2 == null) {
					return;
				}

				if (r1 != this.b2) {
					if (r1.s == S_ON || r2.s == S_ON) return;
				} else {
					if (r2.s == S_ON) return;
				}

				this.b2 = switchBlock(this.b2, r2);
				this.b1 = switchBlock(this.b1, r1);

				this.s = S_ON;
			}

			S1.prototype.update = function () {
			    var s1 = getBelow(this.b1);
			    var s2 = getBelow(this.b2);

			 	this.s = S_OFF;

			    if (s1 == null || s2 == null) {
			        return;
			    }
			    if (s1 != this.b2) {
			        if (s1.s == S_ON || s2.s == S_ON) return;
			    } else {
			        if (s2.s == S_ON) return;
			    }

			    this.b1.s = S_OFF;
			    this.b2.s = S_OFF;

			    this.b1 = s1;
			    this.b2 = s2;

			    this.b1.s = S_ON;
			    this.b2.s = S_ON;

			 	this.s = S_ON;
			}

			// create block grid
			var map = new Array(GRID_ROWS);
			for (var i = 0; i < map.length; i++) {
				map[i] = new Array(GRID_COLUMNS);
				for (var j = 0; j < map[i].length; j++) {
					map[i][j] = new Block(i, j);
				}
			}

			currentShape = new S1(map[2][2],map[2][3]);

			tick();

			function tick() {
				ctx.clearRect(0, 0, g_width, g_height);
				currentShape.update();
				if (currentShape.s == S_OFF) {
					currentShape = new S1(map[2][2], map[2][3]);
				}
				for (var i = 0; i < map.length; i++) {
					for (var j = 0; j < map[i].length; j++) {
						map[i][j].draw();
					}
				}
				ticker = setTimeout(tick, 500);
			}

		});
		</script>
	</head>
	<body>
		<canvas id="game" width="400" height="600"></canvas>
	</body>
</html>